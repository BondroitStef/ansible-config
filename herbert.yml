---
- name: Set-up Herbert, the best VM
  hosts: herbert
  user: root
  vars:
    gitlab_config_template: 'host_files/herbert/gitlab.rb.j2'

  vars_files:
    - vars/herbert_secrets.yml

  tasks:
    - name: Update system
      apt:
        update_cache: yes
      tags: update

    - name: Install utilities
      apt:
        name: "{{ item }}"
        state: latest
      with_items:
        - ack-grep
        - vim
        - zsh
        - tmux
        - htop
        - tree
        - curl
        - unrar
        - unzip
        - etckeeper
        - git-core
        - nodejs
        - yarn
        - speedtest-cli
        - nmap
        - sudo

  roles:
    - role: sshkeys
      tags: sshkeys

    ##########################
    # git.zeus.gent (GitLab) #
    ##########################

    # This installs the GitLab Omnibus package
    - role: geerlingguy.gitlab
      github_app_secret: "{{ gitlab.github_app_secret }}"
      github_app_id: "{{ gitlab.github_app_id }}"
      gitlab_config_template: 'host_files/herbert/gitlab.rb.j2'
      gitlab_create_self_signed_cert: false
      tags:
        - gitlab

    - role: nginx_vhost
      nginx_vhost_file: 'git.zeus.gent'
      tags:
        - nginx
        - gitlab

# Share won't mount on debian 9 somehow...
#    - role: cifs_share
#      share:
#        name: battlebots-data # We're re-using an old share
#        dest: /var/opt/gitlab/git-data/repositories
#        username: "{{ gitlab.share_username }}"
#        password: "{{ gitlab.share_password }}"
#        owner: git
#        dir_mode: 02770
#        file_mode: 02660
#      tags:
#        - shares
#        - gitlab


    ###############################
    # chat.zeus.gent (Rocketchat) #
    ###############################

    # NodeJS global
    # (rocketchat will install a local version, but the global version is 
    # needed to install  the N version manager)
    - role: nodejs
      nodejs_version: 10.x
      tags:
        - rocketchat

    # Database: MongoDB
    # TODO: currently a custom mongoDB version is provided by
    #       the rocketchat role, but we want our own role for that
    # - role: mongodb
    #  tags:
    #    - mongodb
    #    - rocketchat

    # vhost file for our reverse proxy
    - role: nginx_vhost
      nginx_vhost_file: 'chat.zeus.gent'
      tags:
        - nginx
        - rocketchat

    # The actual Rocket.Chat role (https://github.com/RocketChat/Rocket.Chat.Ansible)
    # Currently a fork which supports debian 9: 
    # https://github.com/RocketChat/Rocket.Chat.Ansible/pull/89
    # TODO: use the normal role when PR is merged
    - role: Rocket.Chat.Ansible
      rocket_chat_service_host: chat.zeus.gent
      # automatic upgrades does not mean that rocket.chat will update itself,
      # when ansible runs and the version changes, the ansible role will
      # migrate to the newest version
      # ! Only set this to true when an upgrade has to be done, otherwise
      # it will always perform the (slow) steps to upgrade
      rocket_chat_automatic_upgrades: false
      rocket_chat_include_nginx: false
      tags:
        - rocketchat
