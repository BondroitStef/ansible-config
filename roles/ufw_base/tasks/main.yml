---
- name: Distro specific installation
  include: "{{ ansible_distribution }}.yml"
  tags: install

- name: Copy ufw defaults
  template:
    src: default/ufw
    dest: /etc/default/ufw
  notify: Restart ufw

- name: Copy ufw configurations
  copy:
    src: ufw/
    dest: /etc/ufw/
  notify: Restart ufw

- name: Firewall configuration should be private
  file:
    path: '{{ item }}'
    mode: 'o-rwx,g-xw'
    recurse: yes
  with_items:
    - /etc/ufw
    - /var/lib/ufw

# Reset to delete old, removed rules
- name: Reset ufw
  ufw:
    state: reset

- name: Add SSH rule(s), so we don't lose connection
  ufw:
    rule: allow
    port: "{{ item }}"
  with_items: ufw_ssh_ports

- name: Enable ufw
  ufw:
    state: enabled

- name: Enable and start ufw service
  service:
    name: ufw
    state: started
    enabled: yes

